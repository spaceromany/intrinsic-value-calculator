{% extends "base.html" %}

{% block content %}
<div class="container mt-4">

    <!-- 가치톡! 헤더 -->
    <div class="bg-white rounded shadow-sm p-4 mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <h2 class="mb-0 fw-bold text-primary">
                가치톡!
                <i class="fas fa-info-circle ms-2" 
                   data-bs-toggle="tooltip" 
                   data-bs-html="true"
                   data-bs-placement="right"
                   title="<h5>가치톡! 이용방법</h5>
                          <p>가치톡!은 주식 투자자들을 위한 익명 커뮤니티입니다.</p>
                          <ul>
                            <li>게시물 작성 시 반드시 종목을 태그해야 합니다</li>
                            <li>완전한 익명성을 보장합니다</li>
                            <li>회원가입이 필요하지 않습니다</li>
                            <li>부적절한 내용은 자동으로 필터링됩니다</li>
                          </ul>"
                   style="cursor: pointer; color: #6c757d;"></i>
            </h2>
            <div class="d-flex align-items-center">
                <div class="me-3">
                    <small class="text-muted">내 익명 ID:</small>
                    <span id="currentAnonymousId" class="fw-bold ms-2">로딩중...</span>
                </div>
                <button class="btn btn-outline-primary btn-sm" onclick="refreshAnonymousId()">
                    <i class="fas fa-sync-alt"></i> 새로고침
                </button>
            </div>
        </div>`
    </div>

    <!-- 게시물 목록 섹션 -->
    <div id="postsContainer" class="bg-white rounded shadow-sm p-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="mb-0">최근 게시물</h3>
            <div class="btn-group">
                <button class="btn btn-outline-secondary active" data-filter="all" onclick="filterPosts('all')">전체</button>
                <button class="btn btn-outline-secondary" data-filter="following" onclick="filterPosts('following')">관심종목</button>
                <button class="btn btn-outline-secondary" data-filter="my" onclick="filterPosts('my')">나의 게시글</button>
            </div>
        </div>
        <div id="postsList">
            <!-- 게시물이 여기에 동적으로 로드됩니다 -->
        </div>
    </div>

    <!-- 플로팅 액션 버튼 -->
    <button class="btn btn-primary rounded-circle position-fixed" 
            style="bottom: 2rem; right: 2rem; width: 3.5rem; height: 3.5rem; box-shadow: 0 2px 5px rgba(0,0,0,0.2);"
            data-bs-toggle="modal" 
            data-bs-target="#postModal">
        <i class="fas fa-plus"></i>
    </button>

    <!-- 게시물 작성 모달 -->
    <div class="modal fade" id="postModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">새 게시물 작성</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <div id="stockSearchSection">
                            <div class="input-group mb-3">
                                <input type="text" id="stockSearchInput" class="form-control" placeholder="종목명을 입력하세요">
                                <button class="btn btn-outline-secondary" type="button" onclick="searchStocks()">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                            <div id="stockSearchResults" class="list-group mb-3" style="display: none;"></div>
                        </div>
                        <div id="selectedStocks" class="mb-3">
                            <div class="selected-stock" style="display: none;">
                                <span class="stock-name"></span>
                                <span class="remove-stock" onclick="removeSelectedStock()">
                                    <i class="fas fa-times"></i>
                                </span>
                            </div>
                        </div>
                        <div class="position-relative">
                            <textarea id="postContent" class="form-control mb-2" rows="3" 
                                      placeholder="무슨 생각을 하고 계신가요? (최대 280자)" 
                                      maxlength="280"></textarea>
                            <div class="text-end">
                                <small class="text-muted">
                                    <span id="charCount">0</span>/280
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" class="btn btn-primary" onclick="submitPost()">게시하기</button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .posts-grid {
        display: grid;
        grid-template-columns: repeat(1, 1fr);
        gap: 1rem;
        padding: 1rem;
    }
    @media (min-width: 768px) {
        .posts-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }
    @media (min-width: 1200px) {
        .posts-grid {
            grid-template-columns: repeat(3, 1fr);
        }
    }
    .post-card {
        border: none;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        margin-bottom: 1rem;
        transition: all 0.3s ease;
        cursor: pointer;
        height: 100%;
        display: flex;
        flex-direction: column;
        background-color: #ffffff;
        border-radius: 12px;
    }
    .post-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        transform: translateY(-2px);
    }
    .post-content {
        font-size: 1.1rem;
        line-height: 1.6;
        margin: 1rem 0;
        white-space: pre-wrap;
        word-break: break-word;
        flex-grow: 1;
        color: #2c3e50;
    }
    .post-content.collapsed {
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        max-height: 3.2em;
    }
    .post-stocks {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-left: auto;
    }
    .stock-tag {
        color: #0d6efd;
        text-decoration: none;
        font-size: 0.9rem;
        transition: all 0.2s ease;
    }
    .stock-tag:hover {
        color: #0a58ca;
        text-decoration: none;
    }
    .post-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
    }
    .post-author {
        font-size: 0.95rem;
    }
    .post-meta {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .post-time {
        font-size: 0.85rem;
    }
    .post-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 0.75rem;
        padding-top: 0.75rem;
        border-top: 1px solid #f0f0f0;
    }
    .post-actions {
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    .post-actions i {
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 1.1rem;
    }
    .post-actions i:hover {
        color: #0d6efd;
        transform: scale(1.1);
    }
    .read-more {
        color: #0d6efd;
        cursor: pointer;
        font-size: 0.9rem;
        margin-top: 0.5rem;
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 0.25rem;
        background-color: #f8f9fa;
        transition: all 0.2s ease;
    }
    .read-more:hover {
        background-color: #e7f1ff;
        text-decoration: none;
    }
    .card-body {
        padding: 1.25rem;
    }
    .comments-section {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #f0f0f0;
    }
    .comment-item {
        padding: 0.75rem;
        border-radius: 0.5rem;
        background-color: #f8f9fa;
        margin-bottom: 0.5rem;
        transition: all 0.2s ease;
    }
    .comment-item:hover {
        background-color: #e9ecef;
    }
    .fa-trash-alt {
        font-size: 0.9rem;
        opacity: 0.7;
        transition: all 0.2s ease;
    }
    .fa-trash-alt:hover {
        opacity: 1;
        color: #dc3545 !important;
        transform: scale(1.1);
    }
    .selected-stock {
        display: inline-flex;
        align-items: center;
        padding: 0.5rem 1rem;
        margin: 0.25rem;
        background-color: #e7f1ff;
        color: #0d6efd;
        border-radius: 1rem;
        font-size: 0.875rem;
        border: 1px solid #0d6efd;
    }
    .selected-stock .stock-name {
        font-weight: 500;
    }
    .selected-stock .remove-stock {
        margin-left: 0.75rem;
        cursor: pointer;
        color: #0d6efd;
        opacity: 0.7;
    }
    .selected-stock .remove-stock:hover {
        opacity: 1;
    }
    .comment-icon-wrapper {
        display: inline-block;
        cursor: pointer;
    }
    .comment-count {
        font-size: 0.875rem;
        color: #6c757d;
        margin-left: 2px;
    }
</style>

<script>
let selectedStock = null;  // selectedStocks Set을 단일 변수로 변경

// 디바운스 함수
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// 익명 ID 표시 함수
async function displayAnonymousId() {
    const anonymousId = await getAnonymousId();
    const displayElement = document.getElementById('currentAnonymousId');
    if (anonymousId) {
        displayElement.textContent = anonymousId;
    } else {
        displayElement.textContent = 'ID를 가져올 수 없습니다';
    }
}

// 익명 ID 새로고침 함수
async function refreshAnonymousId() {
    localStorage.removeItem('anonymousId');  // 기존 ID 제거
    await displayAnonymousId();  // 새 ID 표시
}

// 페이지 로드 시 익명 ID 표시
document.addEventListener('DOMContentLoaded', function() {
    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => {
        return new bootstrap.Tooltip(tooltipTriggerEl, {
            html: true,
            trigger: 'hover'
        });
    });

    // 실시간 검색을 위한 이벤트 리스너
    const searchInput = document.getElementById('stockSearchInput');
    const debouncedSearch = debounce(() => {
        const query = searchInput.value.trim();
        if (query.length >= 2) {
            searchStocks();
        } else {
            document.getElementById('stockSearchResults').style.display = 'none';
        }
    }, 300);

    searchInput.addEventListener('input', debouncedSearch);
    
    // 초기 게시물 로드
    loadPosts();
    
    // 익명 ID 표시
    displayAnonymousId();
});

async function searchStocks() {
    const query = document.getElementById('stockSearchInput').value.trim();
    if (!query) return;

    try {
        const response = await fetch(`/search?query=${encodeURIComponent(query)}`);
        const data = await response.json();
        
        const resultsDiv = document.getElementById('stockSearchResults');
        resultsDiv.innerHTML = '';
        
        if (data.stocks && data.stocks.length > 0) {
            data.stocks.forEach(stock => {
                const item = document.createElement('a');
                item.href = '#';
                item.className = 'list-group-item list-group-item-action';
                item.innerHTML = `${stock.name} (${stock.code})`;
                item.onclick = (e) => {
                    e.preventDefault();
                    selectStock(stock);
                    document.getElementById('stockSearchInput').value = '';
                    resultsDiv.style.display = 'none';
                };
                resultsDiv.appendChild(item);
            });
            resultsDiv.style.display = 'block';
        } else {
            resultsDiv.style.display = 'none';
        }
    } catch (error) {
        console.error('검색 중 오류:', error);
    }
}

function selectStock(stock) {
    const container = document.getElementById('selectedStocks');
    const selectedStockDiv = container.querySelector('.selected-stock');
    const stockNameSpan = selectedStockDiv.querySelector('.stock-name');
    
    // 검색 UI 숨기기
    document.getElementById('stockSearchSection').style.display = 'none';
    
    // 선택된 종목 표시
    selectedStockDiv.style.display = 'inline-flex';
    stockNameSpan.textContent = stock.name;
    selectedStock = stock;
}

function removeSelectedStock() {
    const container = document.getElementById('selectedStocks');
    const selectedStockDiv = container.querySelector('.selected-stock');
    selectedStockDiv.style.display = 'none';
    selectedStock = null;
    
    // 검색 UI 다시 표시
    document.getElementById('stockSearchSection').style.display = 'block';
    document.getElementById('stockSearchInput').value = '';
    document.getElementById('stockSearchResults').style.display = 'none';
}

// 익명 ID 관리 함수
async function getAnonymousId() {
    let anonymousId = localStorage.getItem('anonymousId');
    if (!anonymousId) {
        // 서버에서 익명 ID 발급받기
        try {
            const response = await fetch('/valuetalk/anonymous-id', {
                method: 'POST'
            });
            if (response.ok) {
                const data = await response.json();
                anonymousId = data.anonymous_id;
                localStorage.setItem('anonymousId', anonymousId);
            }
        } catch (error) {
            console.error('익명 ID 발급 중 오류:', error);
        }
    }
    return anonymousId;
}

// 글자수 카운터 업데이트 함수
function updateCharCount() {
    const textarea = document.getElementById('postContent');
    const charCount = document.getElementById('charCount');
    const currentLength = textarea.value.length;
    charCount.textContent = currentLength;
    
    // 글자수가 250자 이상이면 색상 변경
    if (currentLength >= 250) {
        charCount.style.color = '#dc3545';
    } else {
        charCount.style.color = '#6c757d';
    }
}

// 모달이 열릴 때 이벤트 리스너 추가
document.getElementById('postModal').addEventListener('show.bs.modal', function () {
    const textarea = document.getElementById('postContent');
    textarea.addEventListener('input', updateCharCount);
    updateCharCount(); // 초기 카운트 업데이트
});

// 모달이 닫힐 때 이벤트 리스너 제거
document.getElementById('postModal').addEventListener('hidden.bs.modal', function () {
    const textarea = document.getElementById('postContent');
    textarea.removeEventListener('input', updateCharCount);
    textarea.value = '';
    document.getElementById('charCount').textContent = '0';
    document.getElementById('charCount').style.color = '#6c757d';
    selectedStock = null;
    const selectedStockDiv = document.querySelector('.selected-stock');
    selectedStockDiv.style.display = 'none';
    document.getElementById('stockSearchSection').style.display = 'block';
    document.getElementById('stockSearchResults').style.display = 'none';
});

async function submitPost() {
    const content = document.getElementById('postContent').value.trim();
    
    if (!selectedStock) {
        alert('종목을 선택해주세요.');
        return;
    }
    
    if (!content) {
        alert('내용을 입력해주세요.');
        return;
    }

    if (content.length > 280) {
        alert('게시물은 280자를 초과할 수 없습니다.');
        return;
    }

    try {
        const anonymousId = await getAnonymousId();
        const response = await fetch('/valuetalk/post', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                content: content,
                stocks: [selectedStock.code],  // 단일 종목 코드를 배열로 전송
                anonymous_id: anonymousId
            })
        });

        // 모달 닫기
        const modal = bootstrap.Modal.getInstance(document.getElementById('postModal'));
        modal.hide();
        
        // 폼 초기화
        document.getElementById('postContent').value = '';
        document.getElementById('charCount').textContent = '0';
        document.getElementById('charCount').style.color = '#6c757d';
        selectedStock = null;
        const selectedStockDiv = document.querySelector('.selected-stock');
        selectedStockDiv.style.display = 'none';
        
        // 게시물 목록 새로고침
        await loadPosts();

        if (!response.ok) {
            const data = await response.json();
            console.error('게시물 작성 중 오류:', data);
        }
    } catch (error) {
        console.error('게시물 작성 중 오류:', error);
    }
}

async function loadPosts(filter = 'all') {
    try {
        const response = await fetch(`/valuetalk/posts?filter=${filter}`);
        const posts = await response.json();
        displayPosts(posts);
    } catch (error) {
        console.error('게시물 로드 중 오류:', error);
    }
}

function displayPosts(posts) {
    const container = document.getElementById('postsList');
    container.innerHTML = '';
    
    if (posts.length === 0) {
        container.innerHTML = '<div class="text-center text-muted py-4">게시물이 없습니다.</div>';
        return;
    }
    
    // 그리드 컨테이너 생성
    const gridContainer = document.createElement('div');
    gridContainer.className = 'posts-grid';
    
    posts.forEach(post => {
        const postElement = createPostElement(post);
        gridContainer.appendChild(postElement);
    });
    
    container.appendChild(gridContainer);
}

function createPostElement(post) {
    const div = document.createElement('div');
    div.className = 'card post-card';
    div.setAttribute('data-post-id', post.id);
    
    const contentClass = 'post-content collapsed';
    
    div.innerHTML = `
        <div class="card-body">
            <div class="post-header">
                <div class="post-author text-muted">
                    <small class="fw-bold">${post.anonymous_id}</small>
                </div>
                <div class="post-meta">
                    ${post.is_owner ? `
                        <i class="fas fa-trash-alt text-muted me-2" style="cursor: pointer;" 
                           onclick="event.stopPropagation(); showPostOptions('${post.id}')"></i>
                    ` : ''}
                    <div class="post-time text-muted">
                        <small>${formatTime(post.created_at)}</small>
                    </div>
                </div>
            </div>
            <div class="post-content-wrapper">
                <div class="${contentClass}" id="content-${post.id}">${post.content}</div>
                <span class="read-more" onclick="event.stopPropagation(); toggleContent('${post.id}')" style="display: none;">
                    더보기
                </span>
            </div>
            <div class="post-footer">
                <div class="post-actions">
                    <span class="like-wrapper" onclick="event.stopPropagation(); likePost('${post.id}')">
                        <i class="far fa-heart me-1" id="like-icon-${post.id}"></i>
                        <span class="like-count" id="like-count-${post.id}">0</span>
                    </span>
                    <span class="comment-icon-wrapper ms-3" onclick="event.stopPropagation(); toggleComments('${post.id}')">
                        <i class="far fa-comment me-1" id="comment-icon-${post.id}"></i>
                        <span class="comment-count" id="comment-count-${post.id}"></span>
                    </span>
                </div>
                <div class="post-stocks">
                    ${post.stocks.map(stock => `
                        <a href="#" class="stock-tag" data-stock-code="${stock.code}" onclick="event.preventDefault(); filterByStock('${stock.code}')">#${stock.name}</a>
                    `).join('')}
                </div>
            </div>
            
            <div id="comments-${post.id}" class="comments-section" style="display: none;">
                <div class="comments-list mb-3"></div>
                <div class="comment-form">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="댓글을 입력하세요..." 
                               id="comment-input-${post.id}">
                        <button class="btn btn-outline-primary" onclick="event.stopPropagation(); submitComment('${post.id}')">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;

    // 카드가 렌더링된 후 더보기 버튼 표시 여부 확인
    setTimeout(() => {
        const content = document.getElementById(`content-${post.id}`);
        const readMore = content.nextElementSibling;
        if (content.scrollHeight > content.clientHeight) {
            readMore.style.display = 'inline-block';
        }
    }, 0);

    // 카드 클릭 이벤트 추가
    div.addEventListener('click', function(e) {
        if (e.target.closest('.comment-form') || e.target.closest('.comments-list')) {
            return;
        }
        
        const commentsSection = document.getElementById(`comments-${post.id}`);
        if (commentsSection.style.display === 'block') {
            commentsSection.style.display = 'none';
        } else {
            commentsSection.style.display = 'block';
            loadComments(post.id);
        }
    });

    loadCommentCount(post.id);
    loadLikeInfo(post.id);
    return div;
}

async function loadCommentCount(postId) {
    try {
        const response = await fetch(`/valuetalk/post/${postId}/comments`);
        const comments = await response.json();
        const count = comments.length;
        
        const countElement = document.getElementById(`comment-count-${postId}`);
        const iconElement = document.getElementById(`comment-icon-${postId}`);
        
        if (count > 0) {
            countElement.textContent = count;
            countElement.style.display = 'inline';
            iconElement.classList.remove('far');
            iconElement.classList.add('fas');
            iconElement.style.color = '#0d6efd';
        } else {
            countElement.style.display = 'none';
            iconElement.classList.remove('fas');
            iconElement.classList.add('far');
            iconElement.style.color = '';
        }
    } catch (error) {
        console.error('댓글 수 로드 중 오류:', error);
    }
}

async function loadLikeInfo(postId) {
    try {
        const response = await fetch(`/valuetalk/post/${postId}/likes`);
        const data = await response.json();
        
        const countElement = document.getElementById(`like-count-${postId}`);
        const iconElement = document.getElementById(`like-icon-${postId}`);
        
        countElement.textContent = data.count;
        
        if (data.is_liked) {
            // 아이콘 클래스 완전히 교체
            iconElement.className = 'fas fa-heart me-1';
            iconElement.style.color = '#dc3545';
        } else {
            // 아이콘 클래스 완전히 교체
            iconElement.className = 'far fa-heart me-1';
            iconElement.style.color = '';
        }
    } catch (error) {
        console.error('좋아요 정보 로드 중 오류:', error);
    }
}

// 좋아요 버튼 스타일 추가
const style = document.createElement('style');
style.textContent = `
    .like-wrapper {
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        padding: 4px 8px;
        border-radius: 4px;
        transition: all 0.2s ease;
    }
    .like-wrapper:hover {
        background-color: rgba(220, 53, 69, 0.1);
    }
    .like-wrapper i {
        font-size: 1.1rem;
        transition: all 0.2s ease;
    }
    .like-wrapper .like-count {
        font-size: 0.9rem;
        margin-left: 4px;
        color: #6c757d;
    }
    .like-wrapper:hover i {
        transform: scale(1.1);
    }
`;
document.head.appendChild(style);

async function likePost(postId) {
    try {
        const response = await fetch(`/valuetalk/post/${postId}/like`, {
            method: 'POST'
        });
        
        if (!response.ok) {
            throw new Error('좋아요 처리에 실패했습니다.');
        }
        
        const data = await response.json();
        await loadLikeInfo(postId);
        
    } catch (error) {
        console.error('좋아요 처리 중 오류:', error);
        alert(error.message);
    }
}

function formatTime(timestamp) {
    if (!timestamp) return '';
    
    // ISO 형식의 시간 문자열을 Date 객체로 변환
    const date = new Date(timestamp);
    const now = new Date();
    
    // 시간 차이 계산 (밀리초)
    const diffMs = now.getTime() - date.getTime();
    
    // 미래 시간인 경우
    if (diffMs < 0) {
        return date.toLocaleString('ko-KR', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            hour12: false
        }).replace(/\. /g, '년 ').replace('.', '월 ').replace('.', '일 ');
    }
    
    // 과거 시간인 경우
    const diffSecs = Math.floor(diffMs / 1000);
    const diffMins = Math.floor(diffSecs / 60);
    const diffHours = Math.floor(diffMins / 60);
    const diffDays = Math.floor(diffHours / 24);
    
    if (diffSecs < 60) {
        return '방금 전';
    } else if (diffMins < 60) {
        return `${diffMins}분 전`;
    } else if (diffHours < 24) {
        return `${diffHours}시간 전`;
    } else if (diffDays < 7) {
        return `${diffDays}일 전`;
    } else {
        return date.toLocaleString('ko-KR', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            hour12: false
        }).replace(/\. /g, '년 ').replace('.', '월 ').replace('.', '일 ');
    }
}

async function filterPosts(filter) {
    try {
        // 버튼 상태 업데이트
        const buttons = document.querySelectorAll('.btn-group .btn');
        buttons.forEach(btn => {
            if (btn.getAttribute('data-filter') === filter) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });
        
        let url = '/valuetalk/posts';
        if (filter === 'following') {
            const watchlist = JSON.parse(localStorage.getItem('watchlist') || '[]');
            if (watchlist.length === 0) {
                alert('관심종목이 없습니다.');
                document.querySelector('[data-filter="all"]').click();
                return;
            }
            url += `?filter=following&watchlist=${encodeURIComponent(JSON.stringify(watchlist))}`;
        } else if (filter === 'my') {
            url += '?filter=my';
        } else {
            url += `?filter=${filter}`;
        }
        
        const response = await fetch(url);
        if (!response.ok) {
            throw new Error('게시물을 불러오는데 실패했습니다.');
        }
        
        const posts = await response.json();
        displayPosts(posts);
    } catch (error) {
        console.error('게시물 필터링 중 오류:', error);
        alert(error.message);
    }
}

async function filterByStock(code) {
    try {
        const response = await fetch(`/valuetalk/posts?filter=stock&code=${code}`);
        if (!response.ok) throw new Error('게시물을 불러오는데 실패했습니다.');
        
        const posts = await response.json();
        displayPosts(posts);
        
        // 필터 버튼 상태 업데이트
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // 제목 업데이트
        const stockName = document.querySelector(`[data-stock-code="${code}"]`)?.textContent.replace('#', '') || code;
        const titleElement = document.querySelector('.display-title');
        if (titleElement) {
            titleElement.textContent = `${stockName} 관련 게시글`;
        }
    } catch (error) {
        console.error('Error:', error);
        alert('게시물을 불러오는데 실패했습니다.');
    }
}

async function toggleComments(postId) {
    const commentsSection = document.getElementById(`comments-${postId}`);
    if (commentsSection.style.display === 'none') {
        commentsSection.style.display = 'block';
        await loadComments(postId);
    } else {
        commentsSection.style.display = 'none';
    }
}

async function loadComments(postId) {
    try {
        const response = await fetch(`/valuetalk/post/${postId}/comments`);
        const comments = await response.json();
        
        const commentsList = document.querySelector(`#comments-${postId} .comments-list`);
        commentsList.innerHTML = '';
        
        // 댓글을 오래된 순으로 정렬 (최신 댓글이 아래에 표시되도록)
        comments.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
        
        comments.forEach(comment => {
            const commentElement = createCommentElement(comment);
            commentsList.appendChild(commentElement);
        });
    } catch (error) {
        console.error('댓글 로드 중 오류:', error);
    }
}

function createCommentElement(comment) {
    const div = document.createElement('div');
    div.className = 'comment-item mb-2';
    div.innerHTML = `
        <div class="d-flex justify-content-between align-items-start">
            <small class="text-muted fw-bold">${comment.anonymous_id}</small>
            <div class="d-flex align-items-center">
                <small class="text-muted me-2">${formatTime(comment.created_at)}</small>
                ${comment.is_owner ? `
                    <i class="fas fa-ellipsis-v text-muted" style="cursor: pointer;" 
                       onclick="showCommentOptions('${comment.id}')"></i>
                ` : ''}
            </div>
        </div>
        <p class="mb-1">${comment.content}</p>
    `;
    return div;
}

async function submitComment(postId) {
    const input = document.getElementById(`comment-input-${postId}`);
    const content = input.value.trim();
    
    if (!content) {
        alert('댓글 내용을 입력해주세요.');
        return;
    }

    try {
        const anonymousId = await getAnonymousId();
        if (!anonymousId) {
            throw new Error('익명 ID를 가져오는데 실패했습니다.');
        }

        const response = await fetch(`/valuetalk/post/${postId}/comment`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
                content,
                anonymous_id: anonymousId
            })
        });

        if (response.ok) {
            input.value = '';
            await loadComments(postId);
            await loadCommentCount(postId);  // 댓글 수 업데이트
        } else {
            const data = await response.json();
            throw new Error(data.error || '댓글 작성에 실패했습니다.');
        }
    } catch (error) {
        console.error('댓글 작성 중 오류:', error);
        alert(error.message);
    }
}

function showCommentOptions(commentId) {
    if (confirm('이 댓글을 삭제하시겠습니까?')) {
        deleteComment(commentId);
    }
}

async function deleteComment(commentId) {
    try {
        const response = await fetch(`/valuetalk/comment/${commentId}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            // 댓글 목록 새로고침
            const postId = document.querySelector(`[data-comment-id="${commentId}"]`).closest('.post-card').dataset.postId;
            await loadComments(postId);
        } else {
            const data = await response.json();
            alert(data.error || '댓글 삭제에 실패했습니다.');
        }
    } catch (error) {
        console.error('댓글 삭제 중 오류:', error);
        alert('댓글 삭제 중 오류가 발생했습니다.');
    }
}

function showPostOptions(postId) {
    if (confirm('이 게시물을 삭제하시겠습니까?')) {
        deletePost(postId);
    }
}

async function deletePost(postId) {
    try {
        console.log('Attempting to delete post:', postId);
        const response = await fetch(`/valuetalk/post/${postId}`, {
            method: 'DELETE'
        });

        const data = await response.json();
        console.log('Delete response:', data);

        if (response.ok) {
            console.log('Post deleted successfully');
            // 게시물 목록 새로고침
            loadPosts();
        } else {
            console.error('Delete failed:', data.error);
            alert(data.error || '게시물 삭제에 실패했습니다.');
        }
    } catch (error) {
        console.error('게시물 삭제 중 오류:', error);
        alert('게시물 삭제 중 오류가 발생했습니다.');
    }
}

function toggleContent(postId) {
    const content = document.getElementById(`content-${postId}`);
    const readMore = content.nextElementSibling;
    
    if (content.classList.contains('collapsed')) {
        // 더보기
        content.classList.remove('collapsed');
        readMore.textContent = '접기';
    } else {
        // 접기
        content.classList.add('collapsed');
        readMore.textContent = '더보기';
    }
}
</script>
{% endblock %} 